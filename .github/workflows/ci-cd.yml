name: CI/CD Workflow

on:
  pull_request:
    branches:
      - main
    types: [ opened, synchronize, reopened ]
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  build-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Generate build tag
        id: tag
        run: |
          # PRãƒ–ãƒ©ãƒ³ãƒåã«åŸºã¥ã„ãŸãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚¿ã‚°åã‚’ä½œæˆ
          # release-waiting-20260128 ã®ã‚ˆã†ãªå½¢å¼ã‹ã‚‰æ—¥ä»˜éƒ¨åˆ†ã‚’æŠ½å‡ºã—ãŸã‚Šã€è¨˜å·ã‚’ç½®æ›
          RAW_BRANCH="${{ github.head_ref }}"
          CLEAN_BRANCH=$(echo "$RAW_BRANCH" | sed 's/release-waiting-//' | sed 's/[^a-zA-Z0-9]/-/g')
          
          # ã‚¿ãƒ–åã¨ã—ã¦åˆ†ã‹ã‚Šã‚„ã™ã„å½¢å¼ã«ï¼ˆä¾‹: 20260128-build-1ï¼‰
          BUILD_TAG="${CLEAN_BRANCH}-build-${{ github.run_number }}"
          
          echo "tag=${BUILD_TAG}" >> $GITHUB_OUTPUT
          echo "branch_for_search=${CLEAN_BRANCH}" >> $GITHUB_OUTPUT
          echo "Build Tag: ${BUILD_TAG}"

      - name: Build
        run: pnpm build

      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.tag.outputs.tag }}
          path: out/

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const tag = "${{ steps.tag.outputs.tag }}";
            const body = `Build completed successfully! ğŸš€\n\n**Build Tag (Tab Name):** ${tag}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

  release-and-deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      pull-requests: read
    outputs:
      release_tag: ${{ steps.release_tag.outputs.tag_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Get PR number with Retry
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const commit_sha = context.sha;
            
            // å¾…æ©Ÿç”¨ã®é–¢æ•°
            const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            
            // æœ€å¤§3å›ã€5ç§’é–“éš”ã§ãƒªãƒˆãƒ©ã‚¤ã™ã‚‹è¨­å®š
            const MAX_RETRIES = 3;
            const DELAY_MS = 5000;

            let pulls = { data: [] };

            // APIã®åæ˜ é…å»¶ã‚’è€ƒæ…®ã—ã¦ãƒªãƒˆãƒ©ã‚¤ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè¡Œ
            for (let i = 0; i < MAX_RETRIES; i++) {
              console.log(`Attempt ${i + 1} to find associated PR...`);
            
              pulls = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner,
                repo,
                commit_sha,
              });

              if (pulls.data.length > 0) {
                break; // PRãŒè¦‹ã¤ã‹ã£ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
              }

              if (i < MAX_RETRIES - 1) {
                console.log(`No PR found yet. Waiting ${DELAY_MS}ms for API consistency...`);
                await wait(DELAY_MS);
              }
            }

            if (pulls.data.length > 0) {
              const pr = pulls.data[0];
              core.setOutput('pr_number', pr.number);
            
              // build-pr ã‚¸ãƒ§ãƒ–ã¨åŒæ§˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã§ã‚¯ãƒªãƒ¼ãƒ³ãªãƒ–ãƒ©ãƒ³ãƒåã‚’ç”Ÿæˆ
              const raw_branch = pr.head.ref;
              core.setOutput('raw_branch', raw_branch);
            
              const clean_branch = raw_branch.replace('release-waiting-', '').replace(/[^a-zA-Z0-9]/g, '-');
              core.setOutput('branch_for_search', clean_branch);
            
              console.log(`Associated PR: ${pr.number}, Branch: ${raw_branch}, Search: ${clean_branch}`);
            } else {
              // ãƒªãƒˆãƒ©ã‚¤å¾Œã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
              core.setFailed('No associated PR found for this commit after retries.');
            }

      - name: Download Artifact from PR
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = "${{ steps.pr_info.outputs.pr_number }}";
            const branch_for_search = "${{ steps.pr_info.outputs.branch_for_search }}";
            const branch_raw = "${{ steps.pr_info.outputs.raw_branch }}";
            
            // æŒ‡å®šãƒ–ãƒ©ãƒ³ãƒã§ã®æœ€æ–°ã®æˆåŠŸã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚’å–å¾—
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              branch: branch_raw,
              status: 'success',
              per_page: 50
            });
            
            console.log(`Searching for runs on branch: ${branch_raw}. Found ${runs.data.workflow_runs.length} successful runs.`);
            
            // PRç•ªå·ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è©¦ã¿ã‚‹
            let pr_run = runs.data.workflow_runs.find(run => 
              run.pull_requests && run.pull_requests.some(pr => pr.number == pr_number)
            );

            // æ˜ç¤ºçš„ã«PRæƒ…å ±ãŒç´ä»˜ã„ã¦ã„ãªã„å ´åˆã€ãƒ–ãƒ©ãƒ³ãƒæœ€æ–°ã®æˆåŠŸå®Ÿè¡Œã‚’ä½¿ç”¨ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            if (!pr_run && runs.data.workflow_runs.length > 0) {
              console.log(`PR #${pr_number} not explicitly found in run metadata. Using the latest successful run on branch ${branch_raw}.`);
              pr_run = runs.data.workflow_runs[0];
            }
            
            if (!pr_run) {
              throw new Error(`No successful workflow run found for branch ${branch_raw} (PR #${pr_number})`);
            }
            
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id: pr_run.id,
            });
            
            // ãƒ–ãƒ©ãƒ³ãƒåï¼ˆã‚¯ãƒªãƒ¼ãƒ³ç‰ˆï¼‰ã‚’å«ã‚€ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’æ¤œç´¢
            const artifact = artifacts.data.artifacts.find(art => art.name.startsWith(branch_for_search));
            
            if (!artifact) {
              throw new Error(`No artifact found starting with ${branch_for_search} for run ${pr_run.id}`);
            }
            
            console.log(`Downloading artifact: ${artifact.name} (ID: ${artifact.id})`);
            
            const download = await github.rest.actions.downloadArtifact({
              owner,
              repo,
              artifact_id: artifact.id,
              archive_format: 'zip',
            });
            
            const fs = require('fs');
            fs.writeFileSync('${{ github.workspace }}/pr-artifact.zip', Buffer.from(download.data));

      - name: Unzip PR artifact
        run: |
          mkdir -p out
          unzip pr-artifact.zip -d out

      - name: Create Release Tag
        id: release_tag
        run: |
          # æ¤œç´¢ç”¨ãƒ–ãƒ©ãƒ³ãƒåï¼ˆä¾‹: 20260128ï¼‰ã‚’ãƒ™ãƒ¼ã‚¹ã«ãƒªãƒªãƒ¼ã‚¹åã‚’ä½œæˆ
          BRANCH_PART="${{ steps.pr_info.outputs.branch_for_search }}"
          TAG_NAME="release-${BRANCH_PART}-$(date +'%H%m%s')"
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT

      - name: Zip artifacts for Release
        run: |
          cd out && zip -r ../build-assets.zip .

      - name: Create Release and Upload Asset
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag_name }}
          name: Release ${{ steps.release_tag.outputs.tag_name }}
          draft: false
          prerelease: false
          files: build-assets.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-to-s3:
    needs: release-and-deploy
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://gekal-nextjs-template-sample.s3-website-ap-northeast-1.amazonaws.com
    steps:
      - name: Download Release Asset
        uses: actions/checkout@v4

      - name: Download Build Artifacts from Release
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          version: 'tags/${{ needs.release-and-deploy.outputs.release_tag }}'
          file: 'build-assets.zip'
          target: 'build-assets.zip' # ä¿®æ­£æ¸ˆã¿: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã¯ãªããƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®š
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Unzip assets
        run: unzip build-assets.zip -d out

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: Deploy to S3
        run: |
          aws s3 sync out/ s3://gekal-nextjs-template-sample --delete
