name: CI/CD Workflow

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  build-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Generate build tag
        id: tag
        run: |
          # PRãƒ–ãƒ©ãƒ³ãƒåã«åŸºã¥ã„ãŸãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚¿ã‚°åã‚’ä½œæˆ
          BRANCH_NAME=$(echo "${{ github.head_ref }}" | sed 's/[^a-zA-Z0-9]/-/g')
          BUILD_TAG="${BRANCH_NAME}-${{ github.run_id }}-${{ github.run_attempt }}"
          echo "tag=${BUILD_TAG}" >> $GITHUB_OUTPUT
          echo "Build Tag: ${BUILD_TAG}"

      - name: Build
        run: pnpm build

      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.tag.outputs.tag }}
          path: out/

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const tag = "${{ steps.tag.outputs.tag }}";
            const body = `Build completed successfully! ğŸš€\n\n**Build Tag (Tab Name):** ${tag}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

  release-and-deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.create_release.outputs.tag_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Create Release Tag
        id: release_tag
        run: |
          TAG_NAME="release-$(date +'%Y%m%d%H%M%S')"
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag_name }}
          name: Release ${{ steps.release_tag.outputs.tag_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Zip artifacts for Release
        run: |
          cd out && zip -r ../build-assets.zip .

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag_name }}
          files: |
            build-assets.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-to-s3:
    needs: release-and-deploy
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://gekal-nextjs-template-sample.s3-website-ap-northeast-1.amazonaws.com
    steps:
      - name: Download Release Asset
        uses: actions/checkout@v4 # ãƒªãƒã‚¸ãƒˆãƒªã®å†…å®¹ãŒå¿…è¦ãªå ´åˆã®ãŸã‚ï¼ˆé€šå¸¸ã¯ä¸è¦ã‹ã‚‚ã—ã‚Œãªã„ãŒå®‰å…¨ç­–ï¼‰
      
      - name: Download Build Artifacts from Release
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          version: 'tags/${{ needs.release-and-deploy.outputs.release_tag }}'
          file: 'build-assets.zip'
          target: './'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Unzip assets
        run: unzip build-assets.zip -d out

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: Deploy to S3
        run: |
          aws s3 sync out/ s3://gekal-nextjs-template-sample --delete
